---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";

type Props = {
  project: CollectionEntry<"projects">;
};

const { project } = Astro.props;
const { data } = project;

type ImageType = string | { type?: string; src: string; caption?: string };

function alternateImages(images: ImageType[]) {
  if (images.length === 0) return [];
  const result = [images[0]];
  const left: ImageType[] = [];
  const right: ImageType[] = [];
  for (let i = 1; i < images.length; i++) {
    if (i % 2 === 1) {
      right.push(images[i]);
    } else {
      left.unshift(images[i]);
    }
  }
  return [...left, ...result, ...right];
}

const images: (string | { src: string; caption?: string; type?: string })[] = alternateImages(data.mediaItems || []);
const leftCount = Math.floor((images.length - 1) / 2);
const previewImage = images[leftCount];

const allMedia = await import.meta.glob<{ default: ImageMetadata | string }>("/src/media/projects/*.{jpg,jpeg,png,webp,svg,avif}");;

const processedMedia = await Promise.all(
  images.map(async (mediaItem) => {
    const isString = typeof mediaItem === "string";
    const src = isString ? mediaItem : mediaItem.src;
    const type = isString ? 'image' : mediaItem.type?.toLowerCase() || 'image';
    
    if (type === 'video') {
      return {
        type: 'video',
        src: src,
        caption: isString ? undefined : mediaItem.caption
      };
    }
    
    const module = allMedia[src];
    if (!module) {
      console.warn(`Media file not found: ${src}`);
      return null;
    }

    const loadedModule = await module();
    return {
      type: 'image',
      src: loadedModule.default,
      caption: isString ? undefined : mediaItem.caption
    }
  })
).then(items => items.filter(Boolean) as Array <{
  type: string;
  src: ImageMetadata | string;
  caption?: string;
}>);

---

<li class="mb-6">
  <div
    id={"slider-" + project.slug}
    class="slider w-screen relative inset-x-1/2 mx-[-50vw] overflow-hidden flex"
    data-center-index={leftCount}
    style="height: 25vh;"
  >
    <div class="h-full">
      <div
        id={"slides-" + project.slug}
        class="flex flex-row h-full items-center"
        style="will-change: transform; transform-origin: center center;"
      >
        {
          processedMedia.map((media, i) => (
            <figure 
              class="relative flex mx-2 transition-opacity duration-300 h-full shrink-0"
              style={i !== leftCount ? "opacity: 0; pointer-events: none;" : "opacity: 1;"}
            >
              {media.type === "video" ? (
                <video
                  src={media.src as string}
                  muted
                  autoplay
                  loop
                  playsinline
                  preload="metadata"
                  class="object-contain h-full"
                  style="display: block;"
                ></video>
              ) : (
                <Image
                  src={media.src as ImageMetadata}
                  alt={data.title}
                  class="object-contain h-full max-w-none"
                  style="display: block; width: auto; height: 100%;"
                  loading="lazy"
                />
              )}
              
              {media.caption && (
                <figcaption
                  class="relative ml-2 mt-auto text-s inline-block caption-toggle select-none opacity-40 max-w-30 text-wrap"
                  data-caption={media.caption}
                >
                  [...]
                </figcaption>
              )}
            </figure>
          ))
        }
      </div>
    </div>
  </div>
  <div
      class="w-screen relative inset-x-1/2 mx-[-50vw] py-2 cursor-ns-resize flex items-center justify-center group"
      id={"resize-handle-" + project.slug} 
      style="z-index: 10;">
      <div class="w-16 h-1 bg-gray-300 group-hover:bg-gray-500 rounded-full transition-all duration-200 group-hover:h-1.5"></div>
  </div>
  <div class="grid grid-cols-6 items-center">
    <h2 class="uppercase col-span-3">{data.title}</h2>
    <p class="col-span-2">{data.categories}</p>
    <p class="text-right">{data.year}</p>
    <p class="col-span-6 mt-1">{project.body}</p>
  </div>
</li>

<script is:inline define:vars={{ project, previewImage }}>
  document.addEventListener("DOMContentLoaded", () => {
    const slider = document.getElementById(`slider-${project.slug}`);
    const slides = document.getElementById(`slides-${project.slug}`);
    const resizeHandle = document.getElementById(`resize-handle-${project.slug}`);

    if (!slider || !slides || !resizeHandle) return;

    const slideImgs = Array.from(slides.children);
    const totalImages = slideImgs.length;
    const centerIndex = parseInt(slider.getAttribute("data-center-index"), 10) || 0;
    
    let isResizing = false;
    let startY = 0;
    let startHeight = 0;
    let index = centerIndex;
    let expanded = false;
    let currentTransformX = 0;
    let justFinishedResizing = false;
    let isProgrammaticResize = false;

    // Touch handling
    let touchStartX = 0;
    let touchStartY = 0;
    let isSwiping = false;

    const isMobile = () => window.innerWidth < 768;

    // --- HELPER FUNCTIONS ---

    function getSide(e) {
      const rect = slider.getBoundingClientRect();
      return e.clientX - rect.left < rect.width / 2 ? "left" : "right";
    }

    function showAllImages(fade = true) {
        slides.querySelectorAll("figure").forEach((fig, i) => {
            fig.style.pointerEvents = "auto";
            if (fade && i !== index) {
                fig.style.transition = "opacity 0.5s";
                fig.style.opacity = "0";
                setTimeout(() => { fig.style.opacity = "1"; }, 10);
            } else {
                fig.style.opacity = "1";
            }
        });
        expanded = true;
    }

    function showPreviewOnly(animate = true) {
        slides.querySelectorAll("figure").forEach((fig, i) => {
            fig.style.pointerEvents = (i === centerIndex) ? "auto" : "none";
            if (animate) {
                fig.style.transition = "opacity 0.5s";
            }
            fig.style.opacity = (i === centerIndex) ? "1" : "0";
        });
        expanded = false;
        index = centerIndex;
    }

    function resetCaptions() {
      slides.querySelectorAll("figcaption").forEach((caption) => {
        caption.textContent = "[...]";
      });
    }

    // --- CORE CENTERING LOGIC ---

    function calculateCenterPosition() {
        if (!slideImgs[index]) return 0;

        let offset = 0;
        for (let i = 0; i < index; i++) {
            const fig = slideImgs[i];
            const media = fig.querySelector("img, video");
            if (media) {
                const mediaWidth = media.getBoundingClientRect().width;
                const style = getComputedStyle(fig);
                const marginLeft = parseInt(style.marginLeft || 0);
                const marginRight = parseInt(style.marginRight || 0);
                offset += mediaWidth + marginLeft + marginRight;
            }
        }

        const currentMedia = slideImgs[index].querySelector("img, video");
        if (!currentMedia) return 0;

        const sliderCenter = slider.offsetWidth / 2;
        const mediaCenter = currentMedia.getBoundingClientRect().width / 2;

        return sliderCenter - offset - mediaCenter;
    }

    function updateSlider(smooth = true) {
        currentTransformX = calculateCenterPosition();
        
        if (isProgrammaticResize) {
            slides.style.transition = "none";
        } else if (smooth) {
            slides.style.transition = "transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
        } else {
            slides.style.transition = "none";
        }

        slides.style.transform = `translateX(${currentTransformX}px)`;

        resetCaptions();

        slideImgs.forEach((fig, i) => {
          const vid = fig.querySelector("video");
          if (vid) {
            if (i === index) vid.play().catch(() => {});
            else vid.pause();
          }
        });
    }

    // --- TOUCH EVENTS (MOBILE) ---

    slider.addEventListener("touchstart", (e) => {
      if (e.target.closest('figcaption')) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
    });

    slider.addEventListener("touchmove", (e) => {
      if (!expanded) return;

      const touchX = e.touches[0].clientX;
      const touchY = e.touches[0].clientY;
      const deltaX = Math.abs(touchX - touchStartX);
      const deltaY = Math.abs(touchY - touchStartY);

      if (deltaX > deltaY && deltaX > 10) {
        isSwiping = true;
        e.preventDefault();
      }
    }, { passive: false });

    slider.addEventListener("touchend", (e) => {
      if (!isSwiping) {
        // Tap to expand or toggle caption
        if (!expanded) {
          showAllImages(true);
          setTimeout(() => updateSlider(true), 50);
        } else if (e.target.closest('figcaption')) {
          const figcaption = e.target.closest('figcaption');
          if (figcaption.textContent === "[...]") {
            figcaption.textContent = `[${figcaption.getAttribute("data-caption")}]`;
          } else {
            figcaption.textContent = "[...]";
          }
        }
        return;
      }

      const touchX = e.changedTouches[0].clientX;
      const deltaX = touchX - touchStartX;

      if (Math.abs(deltaX) > 50) {
        if (deltaX > 0) {
          index = (index - 1 + totalImages) % totalImages;
        } else {
          index = (index + 1) % totalImages;
        }
        updateSlider(true);
      }

      isSwiping = false;
    });

    // --- RESIZE HANDLING (BOTH MOUSE & TOUCH) ---

    function startResize(y) {
      isResizing = true;
      startY = y;
      startHeight = slider.offsetHeight;
      document.body.style.cursor = "ns-resize";
      document.body.style.userSelect = "none";
      slides.style.transition = "none";
    }

    function doResize(y) {
      if (!isResizing) return;
      
      const dy = y - startY;
      const vh = window.innerHeight;
      const minHeight = vh * 0.15;
      const maxHeight = vh * 0.65;
      const newHeight = Math.max(minHeight, Math.min(startHeight + dy, maxHeight));
      
      slider.style.height = `${newHeight}px`;
      requestAnimationFrame(() => updateSlider(false));
    }

    function endResize() {
      if (!isResizing) return;
      
      isResizing = false;
      document.body.style.cursor = "";
      document.body.style.userSelect = "";

      justFinishedResizing = true;
      setTimeout(() => { justFinishedResizing = false; }, 100);

      slides.style.transition = "transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
      setTimeout(() => updateSlider(true), 10);
    }

    resizeHandle.addEventListener("mousedown", (e) => {
      startResize(e.clientY);
      e.preventDefault();
    });

    resizeHandle.addEventListener("touchstart", (e) => {
      startResize(e.touches[0].clientY);
      e.preventDefault();
    }, { passive: false });

    document.addEventListener("mousemove", (e) => doResize(e.clientY));
    
    document.addEventListener("touchmove", (e) => {
      if (isResizing) {
        doResize(e.touches[0].clientY);
        e.preventDefault();
      }
    }, { passive: false });

    document.addEventListener("mouseup", endResize);
    document.addEventListener("touchend", endResize);

    // --- DESKTOP MOUSE INTERACTIONS ---

    let resizeTimeout;
    const resizeObserver = new ResizeObserver(() => {
        if (!isResizing && !isProgrammaticResize) {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                updateSlider(false);
            }, 16);
        }
    });
    resizeObserver.observe(slider);

    slider.addEventListener("click", (e) => {
        if (justFinishedResizing || isMobile()) return;

        if (!expanded) {
            showAllImages(true);
            setTimeout(() => updateSlider(true), 50);
            return;
        }

        if (e.target.closest('figure')) {
            const figcaption = e.target.closest('figcaption');
            if (figcaption) {
                e.stopPropagation();
                if (figcaption.textContent === "[...]") {
                    figcaption.textContent = `[${figcaption.getAttribute("data-caption")}]`;
                } else {
                    figcaption.textContent = "[...]";
                } 
                return;
            }
        }

        if (getSide(e) === "left") {
            index = (index - 1 + totalImages) % totalImages;
        } else {
            index = (index + 1) % totalImages;
        }
        updateSlider(true);
    });

    slider.addEventListener("mousemove", (e) => {
        if (isMobile()) return;
        if (!expanded) slider.style.cursor = "crosshair";
        else slider.style.cursor = getSide(e) === "left" ? "w-resize" : "e-resize";
    });

    slider.addEventListener("mouseleave", () => {
        slider.style.cursor = "default";
    });

    let windowResizeTimeout;
    window.addEventListener("resize", () => {
        clearTimeout(windowResizeTimeout);
        windowResizeTimeout = setTimeout(() => {
            updateSlider(false);
        }, 100);
    });

    document.addEventListener("click", (e) => {
        if (expanded && !slider.contains(e.target)) {
            showPreviewOnly(true);
            setTimeout(() => updateSlider(true), 50);
        }
    });

    window.addEventListener("sliderSizeChange", (e) => {
        const newHeight = e.detail.height;
        
        isProgrammaticResize = true;
        slides.style.transition = "none";
        slider.style.transition = "height 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
        slider.style.height = `${newHeight}px`;
        
        let animationFrameId;
        let startTime = Date.now();
        const animationDuration = 300;
        
        const updateDuringAnimation = () => {
            updateSlider(false);
            
            if (Date.now() - startTime < animationDuration) {
                animationFrameId = requestAnimationFrame(updateDuringAnimation);
            } else {
                isProgrammaticResize = false;
                slider.style.transition = "";
                slides.style.transition = "transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
                cancelAnimationFrame(animationFrameId);
            }
        };
        
        requestAnimationFrame(updateDuringAnimation);
    });

    // INITIALIZATION
    requestAnimationFrame(() => {
        updateSlider(false);
    });
  });
</script>